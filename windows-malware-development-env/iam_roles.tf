# IAM Role for C2-Server
# This Terraform file defines three core elements to developing the AWS IAM permissions for the EC2 instance. 
# 1) The IAM policy to be attached to the IAM role
# 2) The IAM role with the attached policy to be refereenced in the IAM profile
# 3) The IAM profile, which will contain the IAM role (and the attached IAM policy)

# This resource defines the IAM policy
# We will allow all actions to be done to the EC2 instance itself
resource "aws_iam_policy" "win_mal_policy" {

  name = "win-mal-policy"
  policy = jsonencode({

    Version = "2012-10-17"

    Statement = [
      {
        Action = [
          "ec2:*"
        ]
        Effect   = "Allow"
        Resource = "arn:aws:ec2:*:086534668924:instance/*"
      }
    ]

  })

}


# This resource defines the IAM role, itself
# The IAM role will contain a total-access policy to the EC2 instance
resource "aws_iam_role" "win_mal_role" {

  name                = "win-mal-iam-role"
  assume_role_policy  = data.aws_iam_policy_document.iam_document.json
  managed_policy_arns = [aws_iam_policy.win_mal_policy.arn]

}


# This resource defines the IAM profile
# The IAM profile will contain the created IAM role
resource "aws_iam_instance_profile" "win_mal_role_profile" {

  name = "win-mal-iam-role-profile"
  role = aws_iam_role.win_mal_role.name

}